#!/usr/bin/perl -w
use strict;
use Getopt::Long;
use Term::ANSIColor qw(:constants color);
use Cwd;

chdir $1 if $0 =~ /(.+\/)/;
-e 'in/arrows' or die "something went wrong";

sub glob_basename { map { /.+\/(.+)/ } glob "$_[0]/*" }

my @in = glob_basename 'in';

sub read_desc {
    my $filename = shift;
    open my $file, $filename or die "Oops - couldn't read $filename ($!)";
    scalar <$file>; # top line is a throwaway.
    my $desc = <$file>;
    $desc =~ s/^#\s*//;
    $desc
}

sub colored_head { "\n " . CYAN . shift . WHITE ": \n" }
sub usage {
    print colored_head "Nevermind\n";
    print "This no longer has any options. For now we'll install everything.\n";
    print "You can delete whatever `include` lines you want, to pare down.\n";
    exit 1
}

my $be_quiet = 0;
$be_quiet = 1 && shift if $ARGV[0] eq '--quiet';
usage if @ARGV;

sub expand {
    my ($file) = @_;
    my $full_path = cwd() . "/in/$file";
    "include \"$full_path\""
}

my $includes = join "\n", map {
    expand($_)
} @in;
my $result = qq(# See: https://github.com/kragen/xcompose

include "%L" # system mapping, e.g.: /usr/share/X11/locale/en_US.UTF-8/Compose

$includes

# And lastly, your personal config. (At the end, so you get override powers.)
include "%H/.localXCompose"
);

open my $outfile, '>.XCompose' or die "Couldn't open .XCompose: $!";
print $outfile $result or die "Very weird. Couldn't write to .XCompose. ($!)";
close $outfile or die "Superweird. Couldn't close .XCompose. ($!)";

if (not $be_quiet) {
    print MAGENTA "Added the following…\n",
        WHITE $result,
        MAGENTA "…to .XCompose\n";
    print color 'reset';
}
